<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>電子学生証</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Papaparse for CSV reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <!-- Google Fonts (Noto Sans JP) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        .card-container { perspective: 1000px; }
        .card-flipper { position: relative; transform-style: preserve-3d; transition: transform 0.6s; }
        .card-container.flipped .card-flipper { transform: rotateY(180deg); }
        .card-front, .card-back { 
            position: absolute; 
            width: 100%; 
            height: 100%; 
            backface-visibility: hidden; 
            -webkit-backface-visibility: hidden; 
            border-radius: 1rem; 
            overflow: hidden; 
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .card-back { transform: rotateY(180deg); }
        .aspect-id-card { aspect-ratio: 85.60 / 53.98; }
        .timetable-cell {
            padding: 0.5rem 0.25rem;
            cursor: pointer;
            transition: background-color 0.2s;
            vertical-align: top;
            min-height: 50px;
        }
        .timetable-cell:hover { background-color: #f0f9ff; }
        .dark .timetable-cell:hover { background-color: #1e3a8a; }
        
        .force-white-text, .dark .force-white-text { color: #ffffff !important; }
        .dark .date-input-dark { color-scheme: dark; }
        
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 dark:bg-black">

    <div class="w-full bg-gray-50 dark:bg-gray-900 min-h-screen flex flex-col">
        <header id="app-header" class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-20 w-full">
            <div class="max-w-sm mx-auto p-4 flex items-center justify-center relative">
                <button id="back-button" class="hidden absolute left-4 text-gray-600 dark:text-gray-300" onclick="showPortalView()"><i class="fa-solid fa-chevron-left"></i> 戻る</button>
                <a id="logo-link" href="https://www.tcue.ac.jp/" target="_blank" rel="noopener noreferrer" class="absolute left-4">
                    <img src="https://www.tcue.ac.jp/resource/images/common/header_logo_ja.svg" alt="大学ロゴ" class="h-8 w-auto">
                </a>
                <h1 id="header-title" class="font-bold text-lg text-center text-gray-800 dark:text-white">電子学生証</h1>
                <span class="absolute bottom-1 right-2 text-[8px] text-gray-400 dark:text-gray-500">unofficial</span>
            </div>
        </header>

        <div id="portal-view" class="w-full max-w-sm mx-auto flex-grow p-4 md:p-6 flex flex-col items-center">
            <div id="card-container" class="card-container w-full aspect-id-card mb-6" onclick="flipCard()">
                <div class="card-flipper w-full h-full">
                    <div class="card-front">
                        <img src="./student-card-front.jpg" alt="学生証 表面" class="absolute top-0 left-0 w-full h-full object-cover">
                        <div class="absolute cursor-pointer" style="top: 21%; left: 5%; width: 29%; height: 56%;" onclick="showImageModal('./face-photo.jpg', false)"></div>
                        <div class="absolute cursor-pointer" style="top: 80%; left: 5%; width: 35%; height: 10%;" onclick="showImageModal('./barcode.png', true)"></div>
                    </div>
                    <div class="card-back">
                        <img src="./student-card-back.jpg" alt="学生証 裏面" class="absolute top-0 left-0 w-full h-full object-cover">
                    </div>
                </div>
            </div>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">カードの大部分をタップして裏面を表示</p>
            <div class="w-full space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <a href="https://campussquare.tcue.ac.jp/campusweb/ssologin.do" target="_blank" rel="noopener noreferrer" class="block w-full rounded-lg shadow-sm overflow-hidden hover:opacity-80 transition"><img src="https://www.tcue.ac.jp/resource/images/home/bnr-campus_square.jpg" alt="CAMPUS SQUARE" class="w-full h-auto"></a>
                    <a href="https://webclass.tcue.ac.jp/webclass/login.php?auth_mode=SAML" target="_blank" rel="noopener noreferrer" class="block w-full rounded-lg shadow-sm overflow-hidden hover:opacity-80 transition"><img src="https://www.tcue.ac.jp/resource/images/home/bnr-web_class.jpg" alt="Web Class" class="w-full h-auto"></a>
                </div>
                <div class="flex items-stretch gap-3">
                    <a href="https://www-uf01.ufinity.jp/tcuelib/" target="_blank" rel="noopener noreferrer" class="flex-grow flex items-center bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                        <i class="fa-solid fa-book-open text-green-500 w-6 text-center"></i>
                        <span class="ml-4 font-semibold text-gray-700 dark:text-gray-200">図書館情報</span>
                        <i class="fa-solid fa-chevron-right ml-auto text-gray-400"></i>
                    </a>
                    <a href="intent://#Intent;scheme=ufinity;package=com.fujitsu.bunkyo.Ufinity;S.browser_fallback_url=https://play.google.com/store/apps/details?id=com.fujitsu.bunkyo.Ufinity%26hl%3Dja;end" title="Ufinityアプリを開く" class="flex-shrink-0 w-16 flex items-center justify-center bg-white dark:bg-gray-800 rounded-lg shadow-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                        <i class="fa-solid fa-mobile-screen-button text-gray-500 dark:text-gray-300 text-2xl"></i>
                    </a>
                </div>
                <button onclick="showTimetable()" class="w-full flex items-center bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition"><i class="fa-solid fa-calendar-days text-red-500 w-6 text-center"></i><span class="ml-4 font-semibold text-gray-700 dark:text-gray-200">授業時間割</span><i class="fa-solid fa-chevron-right ml-auto text-gray-400"></i></button>
            </div>
        </div>

        <div id="timetable-view" class="w-full max-w-sm mx-auto hidden p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4">
                <div class="grid grid-cols-3 gap-2 mb-4">
                    <div><label for="year-selector" class="text-xs font-bold force-white-text">年度</label><select id="year-selector" class="w-full border rounded p-1 text-sm dark:bg-gray-700 dark:border-gray-600 force-white-text"></select></div>
                    <div><label for="semester-selector" class="text-xs font-bold force-white-text">学期</label><select id="semester-selector" class="w-full border rounded p-1 text-sm dark:bg-gray-700 dark:border-gray-600 force-white-text"></select></div>
                    <div><label for="student-year-selector" class="text-xs font-bold force-white-text">学年</label><select id="student-year-selector" class="w-full border rounded p-1 text-sm dark:bg-gray-700 dark:border-gray-600 force-white-text"><option value="1">1年次</option><option value="2">2年次</option><option value="3">3年次</option><option value="4">4年次</option></select></div>
                </div>
                <div class="overflow-x-auto">
                    <table id="timetable-editor" class="w-full text-xs text-center border-collapse force-white-text">
                        <thead class="bg-gray-100 dark:bg-gray-700"><tr><th class="p-1 border dark:border-gray-600"></th><th class="p-1 border dark:border-gray-600">月</th><th class="p-1 border dark:border-gray-600">火</th><th class="p-1 border dark:border-gray-600">水</th><th class="p-1 border dark:border-gray-600">木</th><th class="p-1 border dark:border-gray-600">金</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <button id="auth-button" onclick="handleAuthClick()" class="mt-4 w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition flex items-center justify-center"><i class="fa-brands fa-google mr-2"></i><span>Googleカレンダーに同期</span></button>
                <p id="sync-status" class="text-center text-sm mt-2 h-5"></p>
            </div>
            <div class="mt-4 p-4 bg-yellow-100 dark:bg-yellow-900/50 rounded-lg text-xs"><p class="font-bold mb-2 force-white-text">初回設定: 各種APIキー</p><p class="mb-1 force-white-text">Googleカレンダー連携機能とAIアシスタント機能を利用するには、各種キーを取得して貼り付けてください。</p><input type="text" id="gemini-api-key-input" placeholder="ここにGemini APIキーを貼り付け" class="w-full p-1 mb-2 border rounded dark:bg-gray-700"><input type="text" id="api-key-input" placeholder="ここにGoogle Calendar APIキーを貼り付け" class="w-full p-1 mb-2 border rounded dark:bg-gray-700"><input type="text" id="client-id-input" placeholder="ここにGoogle OAuthクライアントIDを貼り付け" class="w-full p-1 border rounded dark:bg-gray-700"><button onclick="saveApiKeys()" class="mt-2 w-full bg-gray-600 text-white text-xs py-1 rounded hover:bg-gray-700">保存</button></div>
        </div>
    </div>
    
    <!-- 科目検索モーダル -->
    <div id="class-selector-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm max-h-[80vh] flex flex-col">
            <header class="p-4 border-b dark:border-gray-600">
                <h3 class="font-bold text-lg force-white-text">科目検索</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400">タップで選択、長押しで詳細表示</p>
                <input type="search" id="class-search-input" placeholder="科目名、教員名で検索..." class="w-full p-2 mt-2 border rounded dark:bg-gray-700 dark:border-gray-600">
            </header>
            <main id="class-list" class="p-4 space-y-2 overflow-y-auto"></main>
            <footer class="p-4 border-t dark:border-gray-600 flex justify-end space-x-2">
                 <button onclick="selectClass(null, null, '', '')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">このコマをクリア</button>
                <button onclick="closeModal('class-selector-modal')" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 text-sm">閉じる</button>
            </footer>
        </div>
    </div>
    
    <!-- 科目詳細モーダル -->
    <div id="class-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm max-h-[80vh] flex flex-col">
            <header class="p-4 border-b dark:border-gray-600">
                <h3 id="details-title" class="font-bold text-lg force-white-text">科目詳細</h3>
            </header>
            <main id="details-content" class="p-4 space-y-2 overflow-y-auto text-sm force-white-text"></main>
            <footer class="p-4 border-t dark:border-gray-600 flex justify-end">
                <button onclick="closeModal('class-details-modal')" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 text-sm">閉じる</button>
            </footer>
        </div>
    </div>
    
    <div id="image-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4" onclick="closeImageModal()">
        <div id="brightness-overlay" class="hidden fixed inset-0 bg-white"></div>
        <img id="modal-image" src="" alt="拡大画像" class="max-w-full max-h-full rounded-lg relative z-10">
    </div>

    <script>
        // --- Dark Mode Detection Script ---
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }

        // --- Global Variables ---
        let allCourses = []; 
        let userTimetable = {};
        let longPressTimer;
        const LONG_PRESS_DURATION = 500; // 500ms

        // --- Constants and Settings ---
        const AVAILABLE_YEARS = [2025]; 
        const CLASS_TIMES = [ { start: '08:50', end: '10:20' }, { start: '10:30', end: '12:00' }, { start: '12:40', end: '14:10' }, { start: '14:20', end: '15:50' }, { start: '16:00', end: '17:30' }, { start: '18:00', end: '19:30' }, { start: '19:35', end: '21:05' } ];
        const WEEK_DAYS = ['MO', 'TU', 'WE', 'TH', 'FR'];
        let GEMINI_API_KEY = '';
        let API_KEY = '';
        let CLIENT_ID = '';

        // --- UI Elements ---
        const portalView = document.getElementById('portal-view');
        const timetableView = document.getElementById('timetable-view');
        const headerTitle = document.getElementById('header-title');
        const backButton = document.getElementById('back-button');
        const logoLink = document.getElementById('logo-link');
        const classSelectorModal = document.getElementById('class-selector-modal');
        const classSearchInput = document.getElementById('class-search-input');
        const classList = document.getElementById('class-list');
        const imageModal = document.getElementById('image-modal');
        const modalImage = document.getElementById('modal-image');
        const brightnessOverlay = document.getElementById('brightness-overlay');
        const yearSelector = document.getElementById('year-selector');
        const semesterSelector = document.getElementById('semester-selector');
        const studentYearSelector = document.getElementById('student-year-selector');
        const classDetailsModal = document.getElementById('class-details-modal');
        const detailsTitle = document.getElementById('details-title');
        const detailsContent = document.getElementById('details-content');
        let currentCell = { day: null, period: null };

        function flipCard() { document.getElementById('card-container').classList.toggle('flipped'); }
        function showTimetable() { portalView.classList.add('hidden'); timetableView.classList.remove('hidden'); headerTitle.innerText = '時間割の編集と同期'; backButton.classList.remove('hidden'); logoLink.classList.add('hidden'); }
        function showPortalView() { portalView.classList.remove('hidden'); timetableView.classList.add('hidden'); headerTitle.innerText = '電子学生証'; backButton.classList.add('hidden'); logoLink.classList.remove('hidden'); }

        function showImageModal(src, isBarcode) {
            event.stopPropagation();
            if (isBarcode) {
                brightnessOverlay.classList.remove('hidden');
            } else {
                brightnessOverlay.classList.add('hidden');
            }
            modalImage.src = src;
            imageModal.classList.remove('hidden');
        }
        function closeImageModal() {
            imageModal.classList.add('hidden');
            brightnessOverlay.classList.add('hidden');
        }

        function createTimetableEditor() {
            const tbody = document.querySelector("#timetable-editor tbody");
            tbody.innerHTML = '';
            for (let i = 0; i < 7; i++) {
                const row = document.createElement('tr');
                const periodCell = document.createElement('td');
                periodCell.className = 'font-bold p-1 border dark:border-gray-600 align-middle';
                periodCell.textContent = i + 1;
                row.appendChild(periodCell);
                for (let j = 0; j < 5; j++) {
                    const cell = document.createElement('td');
                    cell.className = 'border dark:border-gray-600 timetable-cell';
                    cell.dataset.day = j; cell.dataset.period = i;
                    cell.onclick = () => openModal(j, i);
                    const cellKey = `d${j}-p${i}`;
                    const savedClass = userTimetable[cellKey];
                    if (savedClass && savedClass.subject) {
                        cell.innerHTML = `<div class="font-bold text-[10px] subject-text">${savedClass.subject}</div><div class="text-[9px] location-text text-gray-500 dark:text-gray-400">${savedClass.teacher}</div>`;
                    } else {
                        cell.innerHTML = '&nbsp;';
                    }
                    row.appendChild(cell);
                }
                tbody.appendChild(row);
            }
        }
        
        // --- Class Search & Details Modals ---
        function openModal(dayIndex, periodIndex) {
            currentCell.day = dayIndex;
            currentCell.period = periodIndex;
            classSearchInput.value = '';
            renderSearchResults(); 
            classSelectorModal.classList.remove('hidden');
        }

        function renderSearchResults() {
            const query = classSearchInput.value.toLowerCase().trim();
            const semester = semesterSelector.value;
            const studentYear = studentYearSelector.value;
            const yearColumn = `配当年次${studentYear}年次`;

            const filteredCourses = allCourses.filter(course => {
                const semesterMatch = course.開校時期 === semester;
                const studentYearMatch = course[yearColumn] === '○';
                const queryMatch = query === '' || (course.科目名 && course.科目名.toLowerCase().includes(query)) || (course.担当教員 && course.担当教員.toLowerCase().includes(query));
                return semesterMatch && studentYearMatch && queryMatch;
            });

            classList.innerHTML = '';
            if (filteredCourses.length > 0) {
                filteredCourses.slice(0, 50).forEach(course => {
                    const item = document.createElement('div');
                    item.className = 'p-3 bg-gray-100 dark:bg-gray-700 rounded-lg cursor-pointer hover:bg-blue-100 dark:hover:bg-blue-900';
                    
                    item.addEventListener('mousedown', (e) => handlePressStart(e, course));
                    item.addEventListener('touchstart', (e) => handlePressStart(e, course));
                    item.addEventListener('mouseup', (e) => handlePressEnd(e, course));
                    item.addEventListener('touchend', (e) => handlePressEnd(e, course));
                    item.addEventListener('mouseleave', () => clearTimeout(longPressTimer));
                    item.addEventListener('touchmove', () => clearTimeout(longPressTimer));

                    item.innerHTML = `
                        <div class="font-bold text-gray-900 dark:text-gray-100">${course.科目名} ${course.クラス ? `(${course.クラス})` : ''}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">${course.担当教員} / ${course.科目分類}</div>
                    `;
                    classList.appendChild(item);
                });
            } else {
                classList.innerHTML = `<p class="text-center text-gray-500">該当する科目がありません。</p>`;
            }
        }
        
        function handlePressStart(event, course) {
            event.preventDefault();
            longPressTimer = setTimeout(() => {
                showClassDetails(course);
            }, LONG_PRESS_DURATION);
        }

        function handlePressEnd(event, course) {
            clearTimeout(longPressTimer);
            if (event.currentTarget.contains(event.target)) {
                 setTimeout(() => { 
                    if (!classDetailsModal.classList.contains('hidden')) return; 
                    selectClass(currentCell.day, currentCell.period, course.科目名, course.担当教員);
                }, 50);
            }
        }

        function showClassDetails(course) {
             if (classSelectorModal.classList.contains('hidden')) return;
            detailsTitle.textContent = course.科目名;
            detailsContent.innerHTML = `
                <p><strong>担当教員:</strong> ${course.担当教員 || '未設定'}</p>
                <p><strong>科目分類:</strong> ${course.科目分類 || '未設定'}</p>
                <p><strong>群:</strong> ${course.群 || 'N/A'}</p>
                <p><strong>区分:</strong> ${course.区分 || 'N/A'}</p>
                <p><strong>開校時期:</strong> ${course.開校時期 || '未設定'}</p>
                <p><strong>単位数:</strong> ${course.単位数 || '未設定'}</p>
                <p><strong>摘要:</strong> ${course.摘要 || 'なし'}</p>
            `;
            classDetailsModal.classList.remove('hidden');
        }
        
        function selectClass(dayIndex, periodIndex, subject, teacher) {
             if (dayIndex === null) { 
                dayIndex = currentCell.day; 
                periodIndex = currentCell.period; 
            }
            const cellKey = `d${dayIndex}-p${periodIndex}`;
            if (subject) {
                userTimetable[cellKey] = { subject, teacher };
            } else {
                delete userTimetable[cellKey];
            }
            saveUserTimetable();
            createTimetableEditor();
            closeModal('class-selector-modal');
        }

        function closeModal(modalId) { 
            document.getElementById(modalId).classList.add('hidden');
        }

        function getTimetableStorageKey() { return `userTimetable_${yearSelector.value}_${semesterSelector.value}`; }
        function saveUserTimetable() { localStorage.setItem(getTimetableStorageKey(), JSON.stringify(userTimetable)); }
        function loadUserTimetable() {
            try {
                const saved = localStorage.getItem(getTimetableStorageKey());
                userTimetable = saved ? JSON.parse(saved) : {};
            } catch (e) { console.error("Failed to load user timetable", e); userTimetable = {}; }
        }
        
        async function loadCourseData(year) {
            const filePath = `./data/${year}.csv`;
            try {
                const response = await fetch(filePath);
                if (!response.ok) throw new Error(`CSV file not found: ${filePath}`);
                const csvText = await response.text();
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        allCourses = results.data;
                        updateTimetableDisplay();
                    },
                    error: (error) => {
                        console.error("CSV parsing error:", error);
                        alert(`${year}.csvの読み込みに失敗しました。`);
                        allCourses = [];
                    }
                });
            } catch (error) {
                console.error("Error fetching CSV:", error);
                alert(`${year}.csvが見つかりません。`);
                allCourses = [];
                updateTimetableDisplay();
            }
        }
        
        // --- (Omitted) API Key, Google Calendar, and other functions remain the same ---
        // ...
        
        function updateTimetableDisplay() {
            loadUserTimetable();
            createTimetableEditor();
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Year Selector
            AVAILABLE_YEARS.forEach(year => {
                const option = new Option(`${year}年度`, year);
                yearSelector.add(option);
            });

            // Initialize Semester Selector
            semesterSelector.innerHTML = '<option value="前期">前期</option><option value="後期">後期</option>';
            
            // --- ★ 修正: 保存された設定を読み込む ---
            const savedYear = localStorage.getItem('selectedYear');
            if (savedYear) yearSelector.value = savedYear;

            const savedSemester = localStorage.getItem('selectedSemester');
            if (savedSemester) {
                semesterSelector.value = savedSemester;
            } else {
                const now = new Date();
                const currentMonth = now.getMonth() + 1;
                semesterSelector.value = (currentMonth >= 4 && currentMonth <= 9) ? "前期" : "後期";
            }
            
            const savedStudentYear = localStorage.getItem('studentYear');
            if (savedStudentYear) studentYearSelector.value = savedStudentYear;
            
            // --- ★ 修正: イベントリスナーで設定を保存する ---
            yearSelector.addEventListener('change', () => {
                localStorage.setItem('selectedYear', yearSelector.value);
                loadCourseData(yearSelector.value);
            });
            semesterSelector.addEventListener('change', () => {
                localStorage.setItem('selectedSemester', semesterSelector.value);
                updateTimetableDisplay();
            });
            studentYearSelector.addEventListener('change', () => {
                localStorage.setItem('studentYear', studentYearSelector.value);
                if (!classSelectorModal.classList.contains('hidden')) {
                    renderSearchResults();
                }
            });
            classSearchInput.addEventListener('input', renderSearchResults);
            
            // Initial Data Load
            loadCourseData(yearSelector.value);
        });
    </script>
</body>
</html>

